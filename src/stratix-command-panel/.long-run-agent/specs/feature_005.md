# Feature feature_005 - 指令取消功能

## 元信息
- **优先级**: P1
- **负责人**: stratix-team
- **预计工时**: 3天
- **创建时间**: 2026-02-22 17:21:52

## 功能描述
支持用户取消正在执行或等待中的指令，发射指令取消事件，并更新指令状态。确保用户可以及时终止不需要的操作。

## 功能设计方案

### 1. 取消指令触发
- **触发场景**：
  - 指令正在执行中（`status: 'running'`）
  - 指令在队列中等待（`status: 'pending'`）
- **触发方式**：
  - **方式 1**：点击指令日志中的"取消"按钮
  - **方式 2**：右键点击 Agent 精灵，选择"取消指令"
  - **方式 3**：使用快捷键（如 Esc）
- **限制条件**：
  - 已执行完成的指令（`status: 'success'` 或 `'failed'`）不能取消

### 2. 取消确认
- **场景**：取消指令是一个不可逆操作
- **确认机制**：
  - 弹出确认对话框
  - 展示即将取消的指令信息（指令 ID、Agent 名称、技能名称）
  - 用户确认后发射取消事件，取消则不执行

### 3. 取消事件发射
- **事件类型**：`stratix:command_cancel`
- **数据结构**：`StratixFrontendOperationEvent`
- **事件数据**：
  ```typescript
  {
    eventType: 'stratix:command_cancel',
    payload: {
      commandId: string  // 要取消的指令 ID
    },
    timestamp: number,
    requestId: string
  }
  ```

### 4. 取消后状态更新
- **UI 更新**：
  - 指令日志中对应指令的状态更新为 `failed` 或 `cancelled`
  - 显示取消原因："用户取消"
  - 取消按钮消失（因为已取消的指令不能再次取消）
- **Agent 状态更新**：
  - 如果 Agent 因该指令处于 `busy` 状态，应恢复为 `online`
  - 如果 Agent 仍在执行其他指令，保持 `busy` 状态

### 5. 批量取消（可选）
- **场景**：用户选中多个 Agent，取消它们正在执行的所有指令
- **处理方式**：
  - 获取所有选中 Agent 的 `running` 或 `pending` 状态指令
  - 批量发射取消事件
  - 批量更新指令状态

### 6. 技术实现
**文件结构**：
```
src/stratix-command-panel/
├── StratixCommandPanel.ts     # 核心逻辑类
└── components/
    └── CommandLog.vue         # 指令日志组件（更新）
```

**核心接口**：
- 发射事件：`stratix:command_cancel`
- 依赖：StratixEventBus, CommandLog 组件

## 开发步骤
- [ ] 步骤 1：在 StratixCommandPanel.ts 中实现 `cancelCommand` 方法
- [ ] 步骤 2：实现取消确认对话框逻辑
- [ ] 步骤 3：实现取消事件发射逻辑
- [ ] 步骤 4：在 CommandLog.vue 中添加"取消"按钮（仅 running/pending 状态显示）
- [ ] 步骤 5：实现取消后指令状态更新逻辑
- [ ] 步骤 6：实现批量取消功能（可选）
- [ ] 步骤 7：集成到 RTS 界面（右键菜单取消指令）
- [ ] 步骤 8：编写单元测试

## 测试用例
| 用例编号 | 场景 | 操作步骤 | 预期结果 |
|----------|------|----------|----------|
| TC-001 | 单个指令取消测试 | 点击运行中指令的"取消"按钮，点击"确认" | 发射 `stratix:command_cancel` 事件，指令状态更新为 `failed`，显示"用户取消" |
| TC-002 | 已完成指令取消测试 | 查看已完成指令的"取消"按钮 | 取消按钮不显示，无法取消已完成的指令 |
| TC-003 | 批量取消测试 | 选中 3 个 Agent，右键选择"取消指令"，点击"确认" | 发射 3 个取消事件，所有指令状态更新为 `failed` |
| TC-004 | 取消确认测试（取消） | 点击取消按钮，在确认对话框中点击"取消" | 不发射取消事件，指令状态保持不变 |
| TC-005 | 取消后 Agent 状态恢复测试 | 取消一个正在执行的指令 | Agent 状态从 `busy` 恢复为 `online`，指令日志状态更新为 `failed` |

## 验收标准
- [ ] 支持取消单个指令（running 或 pending 状态）
- [ ] 仅运行中/等待中的指令显示取消按钮
- [ ] 取消前弹出确认对话框
- [ ] 正确发射 `stratix:command_cancel` 事件
- [ ] 取消后更新指令状态为 `failed`，显示"用户取消"
- [ ] 取消后 Agent 状态正确恢复（如果无其他执行中的指令）
- [ ] 支持批量取消功能（可选）
- [ ] 支持右键菜单取消（可选）
- [ ] 代码通过 ESLint 检查，无类型错误

## 变更记录
| 日期 | 变更内容 | 变更人 |
|------|----------|--------|
| 2026-02-22 | 初始创建 | AI Assistant |
| 2026-02-22 | 迁移内容到 LRA 标准格式 | AI Assistant |
